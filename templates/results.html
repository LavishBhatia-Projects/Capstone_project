{% extends 'base.html' %}

{% block content %}
<div class="row mb-5 fade-in-up">
  <div class="col-lg-8">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb bg-transparent p-0 m-0 small fw-bold text-uppercase">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}"
            class="text-secondary text-decoration-none">Dashboard</a></li>
        <li class="breadcrumb-item active text-primary" aria-current="page">{{ quote }}</li>
      </ol>
    </nav>

    <h1 class="display-5 fw-bold mb-2">{{ quote }}</h1>
    <p class="lead text-secondary mb-0">Analysis & 7-Day Model Forecast</p>
  </div>

  <div class="col-lg-4 d-flex justify-content-lg-end align-items-center mt-4 mt-lg-0 gap-3">
    {% if idea == 'RISE' %}
    <div class="prediction-badge success shadow-sm">
      <span class="badge-label">Outlook</span>
      <span class="badge-value">RISE</span>
    </div>
    {% else %}
    <div class="prediction-badge danger shadow-sm">
      <span class="badge-label">Outlook</span>
      <span class="badge-value">FALL</span>
    </div>
    {% endif %}

    <div
      class="prediction-badge {% if decision == 'BUY' %}success{% elif decision == 'SELL' %}danger{% else %}warning{% endif %} shadow-sm">
      <span class="badge-label">Action</span>
      <span class="badge-value">{{ decision }}</span>
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <!-- Market Data Card -->
  <div class="col-lg-7 fade-in-up delay-100">
    <div class="modern-card h-100">
      <div class="card-header-modern">
        <span><i class="fas fa-chart-bar me-2"></i>Market Data</span>
        <span class="badge bg-light text-secondary border">Today</span>
      </div>
      <div class="card-body-modern">
        <div class="row g-4">
          <div class="col-6 col-sm-3">
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">Close</small>
            <div class="fs-4 fw-bold text-primary ">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ close_s }}
            </div>
          </div>
          <div class="col-6 col-sm-3">
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">Open</small>
            <div class="fs-4 fw-bold">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ open_s }}</div>
          </div>
          <div class="col-6 col-sm-3">
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">High</small>
            <div class="fs-4 fw-bold text-success">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ high_s }}
            </div>
          </div>
          <div class="col-6 col-sm-3">
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">Low</small>
            <div class="fs-4 fw-bold text-danger">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ low_s }}
            </div>
          </div>
          <div class="col-12 pt-2 border-top">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">Volume</small>
              <span class="fw-bold font-monospace">{{ vol }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forecast Summary -->
  <div class="col-lg-5 fade-in-up delay-200">
    <div class="modern-card h-100 bg-primary text-white border-0"
      style="background: linear-gradient(135deg, #1e293b, #0f172a);">
      <div class="card-header-modern bg-transparent text-white border-white border-opacity-10">
        <span><i class="fas fa-robot me-2"></i>Model Forecasts</span>
        <small class="opacity-75">Target: Next Close</small>
      </div>
      <div class="p-0">
        <ul class="list-group list-group-flush bg-transparent">
          <li
            class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center border-white border-opacity-10 py-3 px-4">
            <div>
              <div class="fw-bold">Linear Regression</div>
              <small class="opacity-50">RMSE: {{ error_lr }}</small>
            </div>
            <div class="text-end">
              <div class="fs-5 fw-bold">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ lr_pred }}</div>
            </div>
          </li>
          <li
            class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center border-white border-opacity-10 py-3 px-4">
            <div>
              <div class="fw-bold">LSTM Neural Net</div>
              <small class="opacity-50">RMSE: {{ error_lstm }}</small>
            </div>
            <div class="text-end">
              <div class="fs-5 fw-bold">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ lstm_pred }}</div>
            </div>
          </li>
          <li
            class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center border-0 py-3 px-4">
            <div>
              <div class="fw-bold">ARIMA</div>
              <small class="opacity-50">RMSE: {{ error_arima }}</small>
            </div>
            <div class="text-end">
              <div class="fs-5 fw-bold">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{ arima_pred }}</div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Charts Section -->
<h4 class="mb-4 fade-in-up delay-200">Analysis Visualizations</h4>
<div class="row g-4 mb-5">
  <div class="col-lg-6 fade-in-up delay-300">
    <div class="modern-card p-2 text-center">
      <img src="{{ url_for('static', filename='LR_' ~ quote ~ '.png', t=range(1,9999) | random) }}" class="img-fluid rounded"
        alt="Linear Regression Plot">
    </div>
  </div>
  <div class="col-lg-6 fade-in-up delay-300">
    <div class="modern-card p-2 text-center">
      <img src="{{ url_for('static', filename='LSTM_' ~ quote ~ '.png', t=range(1,9999) | random) }}" class="img-fluid rounded" alt="LSTM Plot">
    </div>
  </div>
  <div class="col-lg-6 fade-in-up delay-300">
    <div class="modern-card p-2 text-center">
      <img src="{{ url_for('static', filename='ARIMA_' ~ quote ~ '.png', t=range(1,9999) | random) }}" class="img-fluid rounded"
        alt="ARIMA Plot">
    </div>
  </div>
  <div class="col-lg-6 fade-in-up delay-300">
    <div class="modern-card p-2 text-center position-relative">
      <div class="position-absolute top-0 start-0 m-3 z-1">
        <span class="badge bg-white shadow-sm text-dark border">Score: {{ "%.3f"|format(sentiment) }}</span>
      </div>
      <img src="{{ url_for('static', filename='SENTIMENT_' ~ quote ~ '.png', t=range(1,9999) | random) }}" class="img-fluid rounded"
        alt="Sentiment Plot">
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <!-- 7 Day Forecast Table -->
  <div class="col-lg-4 fade-in-up delay-300">
    <div class="modern-card h-100">
      <div class="card-header-modern">
        <span>7-Day Price Target</span>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 border-0 text-secondary text-uppercase small">Date</th>
              <th class="pe-4 text-end border-0 text-secondary text-uppercase small">Target</th>
            </tr>
          </thead>
          <tbody>
            {% for data in forecast_set %}
            <tr>
              <td class="ps-4 text-muted">{{ data[0] }}</td>
              <td class="pe-4 text-end fw-bold text-primary">{{ "₹" if ".NS" in quote or ".BO" in quote else "$" }}{{
                data[1] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- News Section -->
  <div class="col-lg-8 fade-in-up delay-300">
    <div class="modern-card h-100">
      <div class="card-header-modern">
        <span>Market News & Sentiment</span>
      </div>
      <div class="list-group list-group-flush overflow-auto" style="max-height: 400px;">
        {% if headlines %}
        {% for item in headlines %}
        <a href="{{ item.url }}" target="_blank" class="list-group-item list-group-item-action p-4 border-bottom">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0 fw-bold text-dark lh-base">{{ item.title }}</h6>
            <span
              class="badge-pill-modern ms-3 text-nowrap {% if item.score > 0.2 %}success{% elif item.score < -0.2 %}danger{% else %}bg-light text-secondary{% endif %}">
              {{ "%.2f"|format(item.score) }}
            </span>
          </div>
          <div class="d-flex align-items-center text-secondary small">
            <i class="far fa-newspaper me-2"></i>
            <span class="me-3">{{ item.source }}</span>
            <i class="far fa-clock me-2"></i>
            <span>{{ item.published }}</span>
          </div>
        </a>
        {% endfor %}
        {% else %}
        <div class="p-5 text-center text-muted">No recent news available.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Fundamentals Section -->
<div class="mb-5 fade-in-up delay-300">
  <div class="modern-card">
    <div class="card-header-modern">
      <span>Fundamental Ratios</span>
      <span class="badge bg-light text-secondary border fw-normal">Source: {{fundamentals_source}}</span>
    </div>
    <div class="card-body-modern">
      <div class="row g-3">
        {% if latest_ratios %}
        {% for name, val in latest_ratios.items() %}
        <div class="col-6 col-md-4 col-lg-2">
          <div class="p-3 rounded bg-light border text-center h-100">
            <div class="text-secondary text-uppercase fw-bold small mb-2 text-truncate" title="{{name}}">{{name}}</div>
            <div class="h5 mb-0 fw-bold text-dark">{{val if val is not none else '-'}}</div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12 py-3 text-center text-muted">Fundamental data not available for this ticker.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}